# SplitMate - 機能・非機能要件書

## 1. プロジェクト概要

### 1.1 目的
夫婦・カップル間の月次家計費精算プロセスを自動化・効率化し、手動作業とヒューマンエラーを削減する家計費精算システム

### 1.2 対象ユーザー
- **夫婦・カップル**：精算処理担当者（夫または妻）と精算依頼者（妻または夫）
- **注記**：精算処理担当者と精算依頼者の役割は必要に応じて交換可能

### 1.3 技術スタック
- **フロントエンド**：React + TypeScript + Vite + Tailwind CSS
- **バックエンド**：Node.js + Express + TypeScript
- **データベース**：PostgreSQL（Supabase）/ MySQL対応
- **認証**：Google OAuth 2.0 + JWT
- **インフラ**：Docker, Netlify（フロントエンド）, Render（バックエンド）, Supabase（DB）

## 2. 機能要件

### 2.1 認証・ユーザー管理機能

#### 2.1.1 Google OAuth認証
- **機能**：Google アカウントによるワンクリックログイン
- **仕様**：
  - Google OAuth 2.0を使用したSSO認証
  - JWT（JSON Web Token）による認証状態管理
  - トークン有効期限：24時間（設定可能）
  - ブラウザのlocalStorageによるトークン保存

#### 2.1.2 カップル管理
- **機能**：カップル登録・管理システム
- **仕様**：
  - 匿名カップル作成機能
  - カップルID生成・管理
  - 役割選択（夫/妻）
  - カップル情報表示ページ

#### 2.1.3 ユーザー登録・管理
- **機能**：ユーザープロファイル管理
- **仕様**：
  - Google認証後の自動ユーザー登録
  - 役割ベースアクセス制御（夫/妻）
  - ユーザーメニュー機能

### 2.2 費用入力・管理機能

#### 2.2.1 費用入力
- **機能**：日常の支出項目入力
- **入力項目**：
  | フィールド | 説明 | 必須 | 例 |
  |-----------|------|-----|---|
  | 説明 | 店舗名または詳細 | ✓ | マルエツ |
  | 金額 | 支出金額 | ✓ | 3,000円 |
  | 支払者 | 実際に支払った人 | ✓ | 夫/妻 |
  | 年月 | 支出年月 | ✓ | 2024年1月 |

#### 2.2.2 費用一覧表示
- **機能**：登録済み費用の一覧表示・管理
- **仕様**：
  - 全費用一覧表示
  - 月次フィルタリング機能
  - 費用詳細表示
  - 個別削除機能
  - 一括削除機能（チェックボックス選択）
  - 費用編集機能

#### 2.2.3 統計情報表示
- **機能**：支出統計の可視化
- **表示項目**：
  - 総支出件数
  - 総支出金額
  - 最小支出金額
  - 月次統計グラフ（実装予定）

### 2.3 配分比率設定機能

#### 2.3.1 全体配分比率設定
- **機能**：夫婦間の基本的な費用負担比率設定
- **仕様**：
  - 夫婦それぞれの負担比率設定（合計100%）
  - デフォルト値：夫70% / 妻30%
  - リアルタイム入力検証
  - 比率変更時の全精算自動再計算

#### 2.3.2 個別配分比率設定
- **機能**：特定の費用項目に対する個別比率設定
- **仕様**：
  - 費用単位でのカスタム配分比率
  - 全体比率の上書き機能
  - 個別比率の有効/無効切り替え

### 2.4 精算計算・管理機能

#### 2.4.1 自動精算計算
- **機能**：費用登録時の自動精算計算
- **計算ロジック**：
  1. 配分比率に基づく各自の負担金額計算
  2. 立替者と精算対象者の決定
  3. 精算金額の算出（立替者でない方の負担分）
  4. 精算方向の決定（誰から誰へ）

#### 2.4.2 精算一覧管理
- **機能**：計算済み精算の表示・管理
- **表示項目**：
  - 費用詳細（説明、金額）
  - 配分計算結果（夫負担額、妻負担額）
  - 立替者・精算対象者
  - 精算金額
  - 精算状況（保留/承認/完了）

#### 2.4.3 精算承認・完了機能
- **機能**：精算プロセスの進行管理
- **ワークフロー**：
  1. **保留状態**：計算完了、承認待ち
  2. **承認状態**：双方合意、振込待ち
  3. **完了状態**：振込完了、精算終了

#### 2.4.4 精算検算機能
- **機能**：精算計算過程の詳細表示
- **仕様**：
  - 個別精算の計算根拠表示
  - ステップバイステップの計算プロセス
  - 全体精算の集計計算表示
  - 最終精算方向と金額の確認

#### 2.4.5 精算完了UX
- **機能**：精算完了までのユーザー体験
- **フロー**：
  1. 「連絡する」ボタンで精算通知
  2. 「精算待機中」状態表示
  3. 「精算完了」ボタンで完了処理
  4. 完了確認とステータス更新

### 2.5 月次管理機能

#### 2.5.1 月次表示
- **機能**：指定年月の費用・精算表示
- **仕様**：
  - 年月選択UI（ドロップダウン）
  - 選択年月の費用一覧フィルタリング
  - 月次統計情報表示
  - 月次精算一覧表示

### 2.6 データ管理機能

#### 2.6.1 一括操作
- **機能**：複数データの効率的な操作
- **仕様**：
  - 費用の一括削除（チェックボックス選択）
  - 全選択/全解除機能
  - 削除前確認ダイアログ
  - 操作結果のフィードバック

#### 2.6.2 データ整合性
- **機能**：データの一貫性維持
- **仕様**：
  - 費用削除時の関連精算自動削除
  - 配分比率変更時の精算自動再計算
  - 重複ユーザー防止機能

## 3. 非機能要件

### 3.1 セキュリティ要件

#### 3.1.1 認証・認可
- **JWT認証**：
  - 秘密鍵による署名検証
  - トークン有効期限管理（24時間）
  - 自動ログアウト機能
- **OAuth 2.0**：
  - Google認証プロバイダー使用
  - 認証フロー・リダイレクト管理
  - プロファイル情報の安全な取得

#### 3.1.2 通信セキュリティ
- **CORS設定**：
  - クロスオリジンリクエスト制御
  - 許可ドメインの明示的設定
  - プリフライトリクエスト対応
- **ヘッダーセキュリティ**：
  - Helmet.js使用
  - セキュリティヘッダー自動設定

#### 3.1.3 セッション管理
- **セッションストア**：
  - PostgreSQL Session Store使用
  - セッション有効期限管理
  - セッションデータの暗号化

### 3.2 パフォーマンス要件

#### 3.2.1 データベース性能
- **マルチDB対応**：
  - PostgreSQL（本番環境推奨）
  - MySQL（開発・テスト環境）
  - Supabase（クラウドPostgreSQL）
- **クエリ最適化**：
  - インデックス設計
  - JOIN最適化
  - 準備済みステートメント使用

#### 3.2.2 フロントエンド性能
- **React最適化**：
  - useMemo/useCallbackによるレンダリング最適化
  - コンポーネント遅延読み込み
  - 状態管理最適化
- **バンドル最適化**：
  - Vite使用による高速ビルド
  - Tree Shaking
  - Code Splitting

### 3.3 可用性要件

#### 3.3.1 エラーハンドリング
- **API エラー処理**：
  - 統一されたエラーレスポンス形式
  - ユーザーフレンドリーなエラーメッセージ
  - エラー状態のUI表示
- **クライアントエラー処理**：
  - Try-catch による例外処理
  - フォールバック UI
  - エラー境界（Error Boundary）

#### 3.3.2 データ整合性
- **トランザクション管理**：
  - データベーストランザクション
  - ロールバック機能
  - データ一貫性保証

### 3.4 スケーラビリティ要件

#### 3.4.1 アーキテクチャ設計
- **マイクロサービス指向**：
  - フロントエンド/バックエンド分離
  - RESTful API設計
  - 疎結合アーキテクチャ
- **データベース設計**：
  - 正規化データベース設計
  - 外部キー制約
  - カスケード削除設定

#### 3.4.2 インフラストラクチャ
- **コンテナ化**：
  - Docker コンテナ使用
  - docker-compose 開発環境
  - マルチステージビルド
- **クラウド対応**：
  - Netlify（フロントエンド）
  - Render（バックエンド）
  - Supabase（データベース）

### 3.5 運用性要件

#### 3.5.1 デプロイメント
- **CI/CD**：
  - Git ベースデプロイ
  - 自動ビルド・テスト
  - 環境別設定管理
- **環境管理**：
  - 開発/本番環境分離
  - 環境変数管理
  - 設定ファイル管理

#### 3.5.2 モニタリング・ログ
- **ログ出力**：
  - 構造化ログ
  - エラーログ
  - アクセスログ
- **ヘルスチェック**：
  - データベース接続確認
  - API ヘルスエンドポイント

#### 3.5.3 AWS リソース管理
- **コスト最適化**：
  - リソース起動/停止スクリプト
  - ECS サービス管理
  - RDS インスタンス管理
- **運用スクリプト**：
  - `scripts/stop-aws-resources.sh`
  - `scripts/start-aws-resources.sh`
  - インタラクティブな確認プロンプト

### 3.6 保守性要件

#### 3.6.1 コード品質
- **TypeScript使用**：
  - 型安全性
  - コンパイル時エラー検出
  - IDE サポート強化
- **バリデーション**：
  - Zod スキーマバリデーション
  - フロントエンド入力検証
  - バックエンドデータ検証

#### 3.6.2 テスト対応
- **テスト環境**：
  - Jest テストフレームワーク
  - Docker テスト環境
  - データベース統合テスト
- **テストカバレッジ**：
  - 認証機能テスト
  - API エンドポイントテスト
  - E2E テスト（実装予定）

#### 3.6.3 ドキュメント
- **API ドキュメント**：
  - RESTful API 仕様
  - エンドポイント一覧
  - リクエスト/レスポンス例
- **運用ドキュメント**：
  - デプロイメントガイド
  - トラブルシューティング
  - 設定変更手順

### 3.7 互換性要件

#### 3.7.1 ブラウザ対応
- **対応ブラウザ**：
  - Chrome（推奨）
  - Firefox
  - Safari
  - Edge
- **モバイル対応**：
  - レスポンシブデザイン
  - タッチ操作対応

#### 3.7.2 データベース互換性
- **マルチDB対応**：
  - PostgreSQL（メイン）
  - MySQL（サブ）
  - データ移行スクリプト

## 4. 今後の拡張予定

### 4.1 通知機能
- LINE Bot 統合
- メール通知
- プッシュ通知

### 4.2 決済統合
- 自動振込連携
- 決済API統合
- 残高管理

### 4.3 分析機能
- 支出傾向分析
- 月次レポート
- 予算管理

### 4.4 多言語対応
- 英語対応
- 国際化（i18n）対応

---

**更新日**: 2025年1月27日  
**バージョン**: v1.0.0 
